@using System.Security.AccessControl
@using Modules.Common
@using Modules.Common.Data
@using Modules.WebApp.Areas.AppCommon.Models.Shared
@using System.Data
@using System.Windows.Forms
@using Modules.WebApp.Areas.AppCommon.Controllers
@using Modules.WebApp.Areas.AppCommon.Models.Shared.FilterControls
@inherits Cx.Framework.Web.Razor.CxWebViewPage<dynamic>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="row">
    <div class="col-sm-3" id="option_tinhdiem">
        <h3>Tính điểm trung bình</h3>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" checked value="Tính điểm trung bình học kỳ"> <span class="label-text">Tính điểm trung bình học kỳ</span>
            </label>
        </div>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" value="Tính điểm trung bình năm học"> <span class="label-text">Tính điểm trung bình năm học</span>
            </label>
        </div>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" value="Tính điểm trung bình toàn khóa"> <span class="label-text">Tính điểm trung bình toàn khóa</span>
            </label>
        </div>
    </div>
</div>
@Html.Partial("~/Areas/AppCommon/Views/Shared/EditFormPartial.cshtml", new EditDataModel
{
    TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh",
    Id = "14",
    MoreExp = "",
    Layout = "editForm"
})

<div class="row">
    <div class="col-lg-12">
        <button id="TinhDiem" type="button" style="margin:5px 0;" class="btnSubmit validate btn blue btn-lg pull-right uppercase">Tính điểm</button>
    </div>
</div>

@Html.Partial("~/Areas/AppCommon/Views/Shared/DataTablePartial.cshtml", new DataTableModel
{
    TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh",
    MoreExp = "",
    Layout = "table",
    UseAjax = false,
    ShowHeader = false
})
</div>
<style>
    /*#div_HocKy_Id, #vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh_NienKhoa-edit-form {
        display: none;
    }*/
</style>
<script type="text/javascript">
    var idSelected = [];
    function DiemTrungBinhDaTa() {
        var nienkhoa_id = $('select[name*="NienKhoa_Id"]').val();
        var lophoc_id = $('select[name*="LopHoc_Id"]').val();
        var hocky_id = $('select[name*="HocKy_Id"]').val();
        if (lophoc_id == "-1") {
            lophoc_id = null;
        }
        if (hocky_id == "-1") {
            hocky_id = null;
        }
        var dataToSend= {
            text: 'uTISRxj9FJY3h+yNENOhsV/mKDi6X6a5wRJ9A0HX6Ayn+7xZAyxnS++6nB1JIsZp7r8B9wfm+navURdWG+3OqKlyruR0dbtbbLlqs1cHg8KizKTOebsiEm1+SjdW2OWd8N3yLISiwRJ99vVbl2DUdA==',
            paramvalue: nienkhoa_id+','+lophoc_id+','+hocky_id
        };
        $.post({
            module: "",
            url: "/AppCommon/Utilities/RunSql",
            showMask: true,
            async: false,
            data: dataToSend,
            success: function () {
                $("body").load('DiemTrungBinh');
            }
            })
        }
    $('#TinhDiem').click(function (e) {
        e.preventDefault();
        DiemTrungBinhDaTa();
    })
    //Radio button on change event
    $(document).ready(function () {
        $('input[name*="schoolyear"]').attr('disabled', true);

        $('input:radio[name=radio]').change(function () {
            if (this.value == 'Tính điểm trung bình học kỳ') {
                $('select[name*="HocKy_Id"]').attr('disabled', false);
                $('input[name*="schoolyear"]').attr('disabled', true);
            }
            else if (this.value == 'Tính điểm trung bình năm học') {
                $('select[name*="HocKy_Id"]').attr('disabled', true);
                $('input[name*="schoolyear"]').attr('disabled', false);
            }
            else if (this.value == 'Tính điểm trung bình toàn khóa') {
                $('select[name*="HocKy_Id"]').attr('disabled', true);
                $('input[name*="schoolyear"]').attr('disabled', true);
            }
        });
        //Show, Hide button
        $("#vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh-btn-cancel,#vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh-btn-update,#btExport_vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh,#btnFullRow_vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh").remove();

    })

</script>



        public ActionResult RunSql(string text, string paramvalue)
        {
            string sql = DataAccessContants.DataProvider.Decrypt_Try_Encode(text);
            if (sql == "")
                return Content("Succ");
            string[] lstParam = paramvalue.Split(',');
            for (int i = 0; i < lstParam.Length; i++)
            {
             
                sql = sql.Replace("{" + i + "}", lstParam[i]);
            }

            string param = Request.QueryString.ToString();
            NameValueCollection qscoll = HttpUtility.ParseQueryString(param);
            foreach (string key in qscoll)
            {
                var value = qscoll[key];
                if (value.IndexOf(";") >= 0)
                {
                    value = " IN (" + value.Replace(";", ",") + ")";
                    sql = sql.Replace("=[" + key + "]", value);
                    sql = sql.Replace("= [" + key + "]", value);
                }
                else
                    sql = sql.Replace("[" + key + "]", value);
            }
            sql = DataAccessContants.DataProvider.ReplaceDefault(sql);
            int r = DataAccessContants.DataProvider.ExecuteCommand(sql);
            return Content("Succ");
        }
