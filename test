using Modules.Common.Data;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace Modules.WebApp.Controllers
{
    public class SUNISDiemTrungBinhController : Controller
    {
        // GET: SUNISDiemTrungBinh
        public ActionResult Index()
        {
            return View();
        }
        public void TinhDiemTrungBinh(int? nienkhoaId, int? lophocId, int? hockyId, int? sinhvienId)
        {
            DataTable tbDiemTrungBinh = new DataTable("tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh");
            DataTable tbdiem = new DataTable();
            DataAccessContants.DataProvider.FillTable(ref tbdiem, "select * from tb_SUNSIS_HCMUNRE_QLLH_LopMonHoc lmh inner join tb_SUNSIS_HCMUNRE_QLLH_LopMonHoc_DSSinhVien diem on lmh.ID=diem.Lop_MonHoc" +
            " inner join tb_SUNSIS_HCMUNRE_QLCTDT_MH mh on lmh.MonHoc=mh.ID" +
            " inner join tb_SUNSIS_HCMUNRE_QLLH_LH lh on lh.ID=lmh.Lophoc_Id" +
            " inner join tb_SUNSIS_HCMUNRE_QLCTDT_NK ctdtnk on lh.ayversion=ctdtnk.ID" +
            " inner join tb_SUNSIS_HCMUNRE_Danhmuc_NienKhoa nk on nk.ID=ctdtnk.ayyear" +
            " inner join tb_SUNSIS_HCMUNRE_DM_HK hk on hk.ID=lmh.HocKy" +
            " join tb_SUNSIS_HCMUNRE_Quyche_Version qc on qc.id=nk.Quyche_Id" +
            " join tb_SUNSIS_HCMUNRE_Quyche_Chungchi cc on qc.Id=cc.Quyche_Id" +
            " where lh.Id =" + lophocId + " and nk.ID =" + nienkhoaId + " and diem.SinhVien_ID=" + sinhvienId + " and lmh.HocKy=" + hockyId + " and diem.Lanhoc=1"+
            " and lmh.MonHoc in (select lmh.MonHoc from tb_SUNSIS_HCMUNRE_QLLH_LopMonHoc lmh where  lmh.MonHoc not in (select * from fnSplitString((SELECT Danhsach_Chungchi from tb_SUNSIS_HCMUNRE_Quyche_Chungchi cc where Quyche_Id = qc.Id), ';')))");
            foreach (DataRow datadiem in tbdiem.Rows)
            {
                double dh10=(Convert.ToDouble(datadiem["Diem_TongKet"]))*(Convert.ToDouble(datadiem[""]));
                



            }
            //DataTable tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh = new DataTable("tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh");
            //DataAccessContants.DataProvider.FillTable(ref tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh, "Select");

            //DataTable tbTemp = new DataTable();
            //DataAccessContants.DataProvider.FillTable(ref tbTemp, "Select");

            ////Dung for de tinh, tinh xong gan vao 1 data

            ////Update
            //tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh.Rows[0]["DiemTB"] = 4.5;

            ////Insert
            //DataRow drnew = tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh.NewRow();
            //tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh.Rows.Add(drnew);
            //drnew["DiemTB"] = 4.5;
            //drnew["DiemChu"] = "Năm";
            //drnew["NgayTinh"] = DateTime.Now;

            ////Luu du lieu

            //DataAccessContants.DataProvider.SaveDataTableBulkCopy(tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh);

        }
    }
}












<div class="row">
    <div class="col-sm-3" id="option_tinhdiem">
        <h3>Tính điểm trung bình</h3>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" checked value="Tính điểm trung bình học kỳ"> <span class="label-text">Tính điểm trung bình học kỳ</span>
            </label>
        </div>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" value="Tính điểm trung bình năm học"> <span class="label-text">Tính điểm trung bình năm học</span>
            </label>
        </div>
        <div class="form-check">
            <label>
                <input type="radio" name="radio" value="Tính điểm trung bình toàn khóa"> <span class="label-text">Tính điểm trung bình toàn khóa</span>
            </label>
        </div>
    </div>
</div>
@Html.Partial("~/Areas/AppCommon/Views/Shared/EditFormPartial.cshtml", new EditDataModel
{
    TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh",
    Id = "14",
    MoreExp = "",
    Layout = "editForm"
})
<div class="row">
    <div class="col-lg-12">
        <button id="TinhDiem" type="button" style="margin:5px 0;" class="btnSubmit validate btn blue btn-lg pull-right uppercase">Tính điểm</button>
    </div>
</div>
@*@Html.Partial("~/Areas/AppCommon/Views/Shared/EditFormPartial.cshtml", new EditDataModel
{
    TableName = "vw_tb_SUNSIS_HCMUNRE_Quyche_Lamtron_ManHinh",
    Id = "1084",
    MoreExp = "",
    Layout = "editForm"
})*@

<div id="DiemTB">
    <div id="DiemTB_HocKy">
        @Html.Partial("~/Areas/AppCommon/Views/Shared/DataTablePartial.cshtml", new DataTableModel
        {
            TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh",
            MoreExp = "",
            Layout = "table",
            UseAjax = false,
            ShowHeader = false
        })
    </div>
</div>
<div id="DiemTB_NamHoc">
    @Html.Partial("~/Areas/AppCommon/Views/Shared/DataTablePartial.cshtml", new DataTableModel
    {
        TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh_NamHoc",
        MoreExp = "",
        Layout = "table",
        UseAjax = false,
        ShowHeader = false
    })
</div>
            </div>
<div id="DiemTB_NienKhoa">
    @Html.Partial("~/Areas/AppCommon/Views/Shared/DataTablePartial.cshtml", new DataTableModel
    {
        TableName = "vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh_NienKhoa",
        MoreExp = "",
        Layout = "table",
        UseAjax = false,
        ShowHeader = false
    })
</div>
            </div>
            </div>
<style>
    /*#DiemTB_HocKy, #DiemTB_NienKhoa, #DiemTB_NamHoc{
            display:none;
        }*/
</style>
<script type="text/javascript">
    var idSelected = [];
    function DiemTrungBinhDaTa() {
        var nienkhoa_id = $('select[name*="NienKhoa_Id"]').val();
        var lophoc_id = $('select[name*="LopHoc_Id"]').val();
        var hocky_id = $('select[name*="HocKy_Id"]').val();
        var sinhvien_id = $('select[name*="Sinhvien_Id"]').val();
        var namhoc = $('input[name="schoolyear"]').val();
        if (lophoc_id == "-1") {
            lophoc_id = null;
        }
        if (hocky_id == "-1") {
            hocky_id = null;
        }
        if (sinhvien_id == "-1") {
            sinhvien_id = null;
        }
        var valueDataToSend = $('input[name=radio]:checked').val();
        if (valueDataToSend == 'Tính điểm trung bình học kỳ') {
            var dataToSend = {
                text: 'uTISRxj9FJY3h+yNENOhsV/mKDi6X6a5wRJ9A0HX6Ayn+7xZAyxnS++6nB1JIsZp7r8B9wfm+navURdWG+3OqKlyruR0dbtbbLlqs1cHg8KizKTOebsiEm1+SjdW2OWd8N3yLISiwRKjL/w6kUvKh0RedsGd3Q98',
                paramvalue: nienkhoa_id + ',' + lophoc_id + ',' + hocky_id + ',' + sinhvien_id
            };
        }
        else if (valueDataToSend == 'Tính điểm trung bình năm học') {
            var dataToSend = {
                text: 'uTISRxj9FJY3h+yNENOhsV/mKDi6X6a5wRJ9A0HX6Ayn+7xZAyxnS++6nB1JIsZp7r8B9wfm+navURdWG+3OqKlyruR0dbtbbLlqs1cHg8K1IpEc8BmsAAOOWuDb2q5QhL7SkWgQx/11pSuol5mCDfmkl4/7D99Kd0vHwai9lpk=',
                paramvalue: nienkhoa_id + ',' + lophoc_id + ',' + namhoc
            };
        }
        else if (valueDataToSend == 'Tính điểm trung bình toàn khóa') {
            var dataToSend = {
                text: 'uTISRxj9FJY3h+yNENOhsV/mKDi6X6a5wRJ9A0HX6Ayn+7xZAyxnS++6nB1JIsZp7r8B9wfm+navURdWG+3OqKlyruR0dbtbbLlqs1cHg8K1IpEc8BmsAFjv1NUZia1TOohRVYemVgq5Q3fJlkESKQF03+zuclrC4bNZzMPWx5s=',
                paramvalue: nienkhoa_id + ',' + lophoc_id
            };
        }
        $.post({
            module: "",
            url: "/AppCommon/Utilities/RunSql",
            showMask: true,
            async: false,
            data: dataToSend,
            success: function () {
               //
            }
        })
    }
    $('#TinhDiem').click(function (e) {
        e.preventDefault();
        DiemTrungBinhDaTa();
        //var nienkhoa_id = $('select[name*="NienKhoa_Id"]').val();
        //var lophoc_id = $('select[name*="LopHoc_Id"]').val();
        //var hocky_id = $('select[name*="HocKy_Id"]').val();
        //var sinhvienid = $('select[name*="Sinhvien_Id"]').val();
        //if (lophoc_id == "-1") {
        //    lophoc_id = null;
        //}
        //if (hocky_id == "-1") {
        //    hocky_id = null;
        //}
        //if (sinhvienid == "-1") {
        //    sinhvienid= null;
        //}
        //var namhoc = null;
        //var parameters = '{nienkhoaId:' + nienkhoa_id + ',lophocId:' + lophoc_id + ',hockyId:' + hocky_id + ',sinhvienId:' + sinhvienid +'}';
        //DiemTrungBinhDaTa();
        //$.ajax({
        //    url: '/SUNISDiemTrungBinh/TinhDiemTrungBinh',
        //    type: 'POST',
        //    data: parameters,
        //    contentType: "application/json; charset=utf-8",
        //    dataType: "json",
        //    success: function (response) {

        //    }
        //})
    })
    //Radio button on change event
        $(document).ready(function () {
        $('input[name*="schoolyear"]').attr('disabled', true);
        $('input:radio[name=radio]').change(function () {
            if (this.value == 'Tính điểm trung bình học kỳ') {
                $('select[name*="HocKy_Id"]').attr('disabled', false);
                $('input[name*="schoolyear"]').attr('disabled', true);
            }
            else if (this.value == 'Tính điểm trung bình năm học') {
                $('select[name*="HocKy_Id"]').attr('disabled', true);
                $('input[name*="schoolyear"]').attr('disabled', false);
                @*$('#DiemTB').load('@Url.Action("PartialDiem", "SUNIS")');*@
            }
            else if (this.value == 'Tính điểm trung bình toàn khóa') {
                $('select[name*="HocKy_Id"]').attr('disabled', true);
                $('input[name*="schoolyear"]').attr('disabled', true);
            }
        });
        $("#vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh-btn-cancel,#vw_tb_SUNSIS_HCMUNRE_QLD_TinhDiemTrungBinh-btn-update,#btExport_vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh,#btnFullRow_vw_tb_SUNSIS_HCMUNRE_QLD_DiemTrungBinh").remove();

    })

</script>
